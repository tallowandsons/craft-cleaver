{% import "_includes/forms" as forms %}

{% set currentEnvironment = environment|upper %}

<div id="cleaver-utility" data-env="{{ envLower }}" data-allowed="{{ allowedListLower }}" data-allowed-flag="{{ isAllowedEnv ? '1' : '0' }}">
    {% if not sections is empty %}
        {% if not isAllowedEnv %}
            <div class="warning-notice cleaver-warning" style="margin-bottom: 16px;">
                ⚠️ Cleaver is disabled in the <strong>{{ currentEnvironment }}</strong> environment.
            </div>
        {% endif %}

        <form id="cleaver-form">
            {{ csrfInput() }}

            <div class="field">
                {{ forms.checkboxSelectField({
                    label: 'Sections'|t('cleaver'),
                    instructions: 'Select which sections to chop entries from'|t('cleaver'),
                    name: 'sections',
                    options: sections,
                    values: selectedSections ?? [],
                    required: true,
                    class: 'fullwidth'
                }) }}
            </div>

            <div class="field">
                {{ forms.textField({
                    label: 'Percent to Remove'|t('cleaver'),
                    instructions: 'Percentage of entries to delete (1-100). Minimum entries per section is always preserved.'|t('cleaver'),
                    name: 'percent',
                    value: settings.defaultPercent,
                    type: 'number',
                    min: 1,
                    max: 100,
                    required: true,
                    size: 10
                }) }}
            </div>

            <div class="field">
                {{ forms.checkboxSelectField({
                    label: 'Entry Statuses'|t('cleaver'),
                    instructions: 'Select which entry statuses to include'|t('cleaver'),
                    name: 'statuses',
                    options: statusOptions,
                    values: settings.defaultStatuses,
                    class: 'fullwidth'
                }) }}
            </div>

            <hr>

            <div class="field">
                {{ forms.lightswitchField({
                    label: 'Dry Run'|t('cleaver'),
                    instructions: 'Simulate the operation without actually deleting entries'|t('cleaver'),
                    name: 'dryRun',
                    on: false
                }) }}
            </div>

            <div class="field">
                {{ forms.lightswitchField({
                    label: 'Soft Delete'|t('cleaver'),
                    instructions: 'Use soft delete instead of permanent deletion'|t('cleaver'),
                    name: 'softDelete',
                    on: settings.defaultDeleteMode == constant('tallowandsons\\cleaver\\models\\Settings::DELETE_MODE_SOFT')
                }) }}
            </div>

            {# Verbose Output removed: configured in plugin settings only #}

            <div class="field" style="margin-top: 30px;">
                <button type="button" id="run-chop-btn" class="btn submit disabled" disabled aria-disabled="true">
                    {{ 'Run Chop'|t('cleaver') }}
                </button>
            </div>
        </form>

        {# Confirmation Modal #}
        <div id="chop-modal" class="cleaver-modal modal hidden">
            <div class="modal-container">
                <div class="modal-header">
                    <h2>{{ 'Confirm Chop Operation'|t('cleaver') }}</h2>
                </div>
                <div class="modal-body">
                    <div class="warning-notice cleaver-warning">
                        <strong>⚠️ Warning: You are about to delete entries in {{ currentEnvironment }}</strong>
                    </div>

                    <div id="chop-summary" class="cleaver-summary">
                        <!-- Summary will be populated via JavaScript -->
                    </div>

                    <div class="field">
                        {{ forms.textField({
                            label: 'Type the environment name to confirm'|t('cleaver'),
                            instructions: 'Type "' ~ currentEnvironment ~ '" to confirm this operation'|t('cleaver'),
                            id: 'confirm-environment',
                            name: 'confirmEnvironment',
                            placeholder: currentEnvironment,
                            required: true
                        }) }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="cancel-chop" class="btn">
                        {{ 'Cancel'|t('cleaver') }}
                    </button>
                    <button type="submit" id="confirm-chop" class="btn submit disabled" disabled>
                        {{ 'Confirm Chop'|t('cleaver') }}
                    </button>
                </div>
            </div>
        </div>

        {# Loading Overlay #}
        <div id="loading-overlay" class="hidden cleaver-loading">
            <div class="cleaver-panel">
                <div class="spinner"></div>
                <div>{{ 'Processing chop operation...'|t('cleaver') }}</div>
            </div>
        </div>

    {% else %}
        <div class="zilch">
            <p>{{ 'No sections found.'|t('cleaver') }}</p>
        </div>
    {% endif %}
</div>
